name: Azure Task + Discord Sync

on:
  push:
    branches:
      - main
      - master

jobs:
  azure_discord_sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect commit message
        id: detect
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "Commit detectado: $COMMIT_MSG"

      # üÜï Crear una tarea en Azure si el commit contiene "TODO"
      - name: Create task in Azure if commit contains 'TODO'
        if: contains(steps.detect.outputs.commit_msg, 'TODO')
        run: |
          AUTH=$(printf ":${{ secrets.AZURE_PAT }}" | base64 | tr -d '\n')
          TaskType=Task
          curl -X POST \
            -H "Content-Type: application/json-patch+json" \
            -H "Authorization: Basic $AUTH" \
            -d "[
              {\"op\": \"add\", \"path\": \"/fields/System.Title\", \"value\": \"Tarea creada desde commit: ${{ steps.detect.outputs.commit_msg }}\"},
              {\"op\": \"add\", \"path\": \"/fields/System.State\", \"value\": \"To Do\"}
            ]" \
              "https://dev.azure.com/${{ secrets.AZURE_ORG}}/${{ secrets.AZURE_PROJECT}}/_apis/wit/workitems/${TaskType}?api-version=7.0"


      - name: Send Discord message on task creation
        if: contains(steps.detect.outputs.commit_msg, 'TODO')
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"üÜï Nueva tarea creada en Azure por commit: **${{ steps.detect.outputs.commit_msg }}**\"}" \
            ${{ secrets.DISCORD_WEBHOOK }}

      # ‚úÖ Mover una tarea a "Done" si el commit contiene "DONE"
      - name: Move task to Done if commit contains 'DONE'
        if: contains(steps.detect.outputs.commit_msg, 'DONE')
        run: |
          AUTH=$(printf ":${{ secrets.AZURE_PAT }}" | base64 | tr -d '\n')
          TASK_ID=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Basic $AUTH" \
            -d "{\"query\": \"Select [System.Id] From WorkItems Where [System.Title] Contains '${{ steps.detect.outputs.commit_msg }}'\"}" \
            "https://dev.azure.com/${{ secrets.AZURE_ORG}}/${{ secrets.AZURE_PROJECT}}/_apis/wit/wiql?api-version=7.0" | jq -r '.workItems[0].id')

          if [ "$TASK_ID" != "null" ] && [ -n "$TASK_ID" ]; then
            curl -X PATCH \
              -H "Content-Type: application/json-patch+json" \
              -H "Authorization: Basic $AUTH" \
              -d '[{"op": "add", "path": "/fields/System.State", "value": "Done"}]' \
              "https://dev.azure.com/${{ secrets.AZURE_ORG}}/${{ secrets.AZURE_PROJECT}}/_apis/wit/workitems/$TASK_ID?api-version=7.0"
          else
            echo "‚ö†Ô∏è No se encontr√≥ ninguna tarea para actualizar."
          fi

      - name: Send Discord message on task done
        if: contains(steps.detect.outputs.commit_msg, 'DONE')
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"‚úÖ Tarea marcada como completada por push: **${{ steps.detect.outputs.commit_msg }}**\"}" \
            ${{ secrets.DISCORD_WEBHOOK }}
