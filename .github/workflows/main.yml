name: Azure Task + Discord Sync

on:
  push:
    branches:
      - main
      - master

jobs:
  azure_discord_sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install JQ (JSON Processor)
        run: sudo apt-get install jq

      - name: Detect commit message
        id: detect
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          # 1. Capturar la fecha del commit para el mensaje de Discord
          COMMIT_DATE=$(git log -1 --pretty=format:'%as')
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT
          echo "Commit detectado: $COMMIT_MSG (Fecha: $COMMIT_DATE)"

      # üÜï Crear una tarea en Azure si el commit contiene "TODO"
      - name: Create task in Azure if commit contains 'TODO'
        id: create_task # ID para capturar outputs
        if: contains(steps.detect.outputs.commit_msg, 'TODO')
        run: |
          # 2. Corregido: La autenticaci√≥n usa el formato b√°sico de User:PAT (User vac√≠o)
          AUTH=$(printf ":${{ secrets.AZURE_PAT }}" | base64 | tr -d '\n')
          TaskType=Task
          
          # Hacemos el POST y capturamos la respuesta JSON para extraer el ID y t√≠tulo
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json-patch+json" \
            -H "Authorization: Basic $AUTH" \
            -d "[
              {\"op\": \"add\", \"path\": \"/fields/System.Title\", \"value\": \"Tarea creada desde commit: ${{ steps.detect.outputs.commit_msg }}\"},
              {\"op\": \"add\", \"path\": \"/fields/System.State\", \"value\": \"To Do\"}
            ]" \
            "https://dev.azure.com/${{ secrets.AZURE_ORG}}/${{ secrets.AZURE_PROJECT}}/_apis/wit/workitems/${TaskType}?api-version=7.0")
            
          # Extraemos y exportamos el ID y el T√≠tulo
          TASK_ID=$(echo "$RESPONSE" | jq -r '.id')
          TASK_TITLE=$(echo "$RESPONSE" | jq -r '.fields."System.Title"')
          
          echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT
          echo "task_title=$TASK_TITLE" >> $GITHUB_OUTPUT
          echo "Tarea Azure ID: $TASK_ID creada."
          
      - name: Send Discord message on task creation
        if: contains(steps.detect.outputs.commit_msg, 'TODO') && steps.create_task.outputs.task_id != 'null'
        run: |
          # 3. Mensaje de Discord mejorado con ID, T√≠tulo y Fecha
          MESSAGE="üÜï **Nueva Tarea Azure Creada** (ID: ${{ steps.create_task.outputs.task_id }})\n"
          MESSAGE+="**T√≠tulo:** _${{ steps.create_task.outputs.task_title }}_ \n"
          MESSAGE+="**Commit:** _${{ steps.detect.outputs.commit_msg }}_ \n"
          MESSAGE+="**Fecha Commit:** `${{ steps.detect.outputs.commit_date }}`"
          
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"$MESSAGE\"}" \
            ${{ secrets.DISCORD_WEBHOOK }}

      # ‚úÖ Mover una tarea a "Done" si el commit contiene "DONE"
      # (Este bloque no necesita cambios, funciona correctamente)
      - name: Move task to Done if commit contains 'DONE'
        if: contains(steps.detect.outputs.commit_msg, 'DONE')
        run: |
          AUTH=$(printf ":${{ secrets.AZURE_PAT }}" | base64 | tr -d '\n')
          TASK_ID=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Basic $AUTH" \
            -d "{\"query\": \"Select [System.Id] From WorkItems Where [System.Title] Contains '${{ steps.detect.outputs.commit_msg }}'\"}" \
            "https://dev.azure.com/${{ secrets.AZURE_ORG}}/${{ secrets.AZURE_PROJECT}}/_apis/wit/wiql?api-version=7.0" | jq -r '.workItems[0].id')

          if [ "$TASK_ID" != "null" ] && [ -n "$TASK_ID" ]; then
            curl -X PATCH \
              -H "Content-Type: application/json-patch+json" \
              -H "Authorization: Basic $AUTH" \
              -d '[{"op": "add", "path": "/fields/System.State", "value": "Done"}]' \
              "https://dev.azure.com/${{ secrets.AZURE_ORG}}/${{ secrets.AZURE_PROJECT}}/_apis/wit/workitems/$TASK_ID?api-version=7.0"
          else
            echo "‚ö†Ô∏è No se encontr√≥ ninguna tarea para actualizar."
          fi

      - name: Send Discord message on task done
        if: contains(steps.detect.outputs.commit_msg, 'DONE')
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"‚úÖ Tarea marcada como completada por push: **${{ steps.detect.outputs.commit_msg }}**\"}" \
            ${{ secrets.DISCORD_WEBHOOK }}
