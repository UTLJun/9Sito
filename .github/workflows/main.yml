name: Azure Task + Discord Sync

on:
  push:
    branches:
      - main
      - master

jobs:
  azure_discord_sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install JQ (JSON Processor)
        run: sudo apt-get install jq

      - name: Detect commit message
        id: detect
        run: |
          # Captura del mensaje y fecha del commit
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_DATE=$(git log -1 --pretty=format:'%as')
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT
          echo "Commit detectado: $COMMIT_MSG (Fecha: $COMMIT_DATE)"

      # üÜï Crear una tarea en Azure si el commit contiene "TODO"
      - name: Create task in Azure if commit contains 'TODO'
        id: create_task
        if: contains(steps.detect.outputs.commit_msg, 'TODO')
        run: |
          # 1. SOLUCI√ìN ALTERNATIVA DE AUTENTICACI√ìN: 
          # Se codifica SOLO el PAT. Azure DevOps a menudo permite esto para Basic Auth
          # cuando la codificaci√≥n de ':PAT' falla debido a errores de seguridad de path.
          AUTH=$(echo -n "${{ secrets.AZURE_PAT }}" | base64)
          TaskType=Task
          
          # 2. Llamada a la API: Una sola llamada para obtener la respuesta completa
          RESPONSE_AND_CODE=$(curl -s -X POST \
            -H "Content-Type: application/json-patch+json" \
            -H "Authorization: Basic $AUTH" \
            -d "[
              {\"op\": \"add\", \"path\": \"/fields/System.Title\", \"value\": \"Tarea creada desde commit: ${{ steps.detect.outputs.commit_msg }}\"},
              {\"op\": \"add\", \"path\": \"/fields/System.State\", \"value\": \"To Do\"}
            ]" \
            -w "%{http_code}" \
            "https://dev.azure.com/${{ secrets.AZURE_ORG}}/${{ secrets.AZURE_PROJECT}}/_apis/wit/workitems/${TaskType}?api-version=7.0")

          # 3. Separar el c√≥digo HTTP (√∫ltimos 3 d√≠gitos) del cuerpo de la respuesta
          HTTP_CODE=${RESPONSE_AND_CODE:(-3)}
          RESPONSE_BODY=${RESPONSE_AND_CODE:0:${#RESPONSE_AND_CODE}-3}
          
          echo "C√≥digo HTTP de Azure: $HTTP_CODE"
          echo "Respuesta de Azure: $RESPONSE_BODY"
          
          # 4. Evaluaci√≥n del resultado
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              # Tarea creada con √©xito
              TASK_ID=$(echo "$RESPONSE_BODY" | jq -r '.id')
              TASK_TITLE=$(echo "$RESPONSE_BODY" | jq -r '.fields."System.Title"')
              
              if [ "$TASK_ID" == "null" ]; then
                echo "::error title=JSON Inesperado::La API devolvi√≥ √©xito, pero el ID de la tarea es nulo."
                exit 1
              fi

              echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT
              echo "task_title=$TASK_TITLE" >> $GITHUB_OUTPUT
              echo "Tarea Azure ID: $TASK_ID creada con √©xito."
          else
              # Fallo en la creaci√≥n
              echo "::error title=Fallo en Azure API::La creaci√≥n de la tarea fall√≥ con c√≥digo HTTP $HTTP_CODE. Respuesta: $RESPONSE_BODY"
              echo "task_id=null" >> $GITHUB_OUTPUT
              echo "task_title=Fallo en la creaci√≥n" >> $GITHUB_OUTPUT
              exit 1 # Forzar la falla del paso si la creaci√≥n fall√≥
          fi

      - name: Send Discord message on task creation
        # Solo se ejecuta si la tarea se cre√≥ con √©xito (task_id no es 'null')
        if: contains(steps.detect.outputs.commit_msg, 'TODO') && steps.create_task.outputs.task_id != 'null'
        run: |
          MESSAGE="üÜï **Nueva Tarea Azure Creada** (ID: ${{ steps.create_task.outputs.task_id }})\n"
          MESSAGE+="**T√≠tulo:** _${{ steps.create_task.outputs.task_title }}_ \n"
          MESSAGE+="**Commit:** _${{ steps.detect.outputs.commit_msg }}_ \n"
          MESSAGE+="**Fecha Commit:** `${{ steps.detect.outputs.commit_date }}`"
          
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"$MESSAGE\"}" \
            ${{ secrets.DISCORD_WEBHOOK }}

      ---
      # ‚úÖ Mover una tarea a "Done" si el commit contiene "DONE"
      - name: Move task to Done if commit contains 'DONE'
        if: contains(steps.detect.outputs.commit_msg, 'DONE')
        run: |
          # Aqu√≠ volvemos a usar la sintaxis est√°ndar de AUTH porque esta query no falla tanto
          AUTH=$(printf ":${{ secrets.AZURE_PAT }}" | base64 | tr -d '\n')
          
          # Primero, buscamos la tarea por su t√≠tulo (usando el mensaje del commit)
          TASK_ID=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Basic $AUTH" \
            -d "{\"query\": \"Select [System.Id] From WorkItems Where [System.Title] Contains '${{ steps.detect.outputs.commit_msg }}'\"}" \
            "https://dev.azure.com/${{ secrets.AZURE_ORG}}/${{ secrets.AZURE_PROJECT}}/_apis/wit/wiql?api-version=7.0" | jq -r '.workItems[0].id')

          if [ "$TASK_ID" != "null" ] && [ -n "$TASK_ID" ]; then
            # Segundo, actualizamos el estado
            curl -X PATCH \
              -H "Content-Type: application/json-patch+json" \
              -H "Authorization: Basic $AUTH" \
              -d '[{"op": "add", "path": "/fields/System.State", "value": "Done"}]' \
              "https://dev.azure.com/${{ secrets.AZURE_ORG}}/${{ secrets.AZURE_PROJECT}}/_apis/wit/workitems/$TASK_ID?api-version=7.0"
          else
            echo "‚ö†Ô∏è No se encontr√≥ ninguna tarea para actualizar."
          fi

      - name: Send Discord message on task done
        if: contains(steps.detect.outputs.commit_msg, 'DONE')
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"‚úÖ Tarea marcada como completada por push: **${{ steps.detect.outputs.commit_msg }}**\"}" \
            ${{ secrets.DISCORD_WEBHOOK }}
